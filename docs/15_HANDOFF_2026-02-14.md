# HANDOFF — Lembrete Psi (2026-02-14)

> Objetivo clínico constante: **sustentar vínculo terapêutico** e reduzir absenteísmo com lembretes + psicoeducação + responsabilização.
> O app não é “secretária”: é ferramenta de constância.

## 1) Decisões de hoje
- **Pausar Capacitor** e focar em estabilizar/elevar a experiência WEB.
- **Contrato**:
  - Mesmo aceito, deve ficar disponível para **leitura futura** pelo paciente (menu superior).
- **Psicoeducação**:
  - Manter **um mantra fixo** no topo (leve, curto, sem tom punitivo).
  - Remover frases redundantes no header para evitar poluição.
- **Padrão de telefone**:
  - Manter `phoneCanonical` como chave de referência do paciente **SEM “55”** (DDD + número, ex.: `11999998888`).

## 2) Problemas encontrados e correções aplicadas

### A) Turbopack “panic”
**Sintoma:** `FATAL: An unexpected Turbopack error occurred. A panic log has been written...`  
**Efeito:** rotas `/api/**` compilavam com erro e devolviam 500 em cadeia.  
**Correção:** patch para estabilizar bundle/rotas server (especialmente envolvendo inicialização/import do Firebase Admin).  
**Resultado:** panic **sumiu**.

### B) `/api/patient/resolve-phone` 400
**Sintoma:** `GET /api/patient/resolve-phone 400 (Bad Request)`  
**Causa provável:** rota não encontrava `phoneCanonical` (doc `users/{uid}` incompleto ou claims não lidas).  
**Correção:** rota passou a:
- ler `phoneCanonical` também de claims/pareamento quando disponível;
- persistir `phoneCanonical` no `users/{uid}` quando ausente;
- retornar respostas consistentes.
**Resultado:** tudo **200**.

### C) Build quebrando na Vercel (merge markers)
**Sintoma:** `Merge conflict marker encountered` + `Command "npm run build" exited with 1`  
**Arquivos apontados:**  
- `src/app/api/admin/patient/pair-code/route.js`  
- `src/app/api/admin/push/status-batch/route.js`  
- `src/app/api/patient/pair/route.js`  
**Correção:** remoção de `<<<<<<<`, `=======`, `>>>>>>>` e consolidação de trechos.  
**Resultado:** build volta a compilar (validar amanhã com `npm run build` e deploy verde).

## 3) Melhorias de UX concluídas (Paciente)
1) **Seu próximo atendimento**
   - destaque sutil para diferenciar dos outros blocos;
   - layout com quebra de linha e contraste melhor no mobile para:
     - data/hora
     - profissional
     - local
2) **Contrato sempre disponível**
   - item no menu superior “Contrato” → abre modal para leitura;
   - mostra status (aceito/pendente) e versão do contrato.
3) **Menu legível**
   - “Admin” e “Sair” estavam claros demais → corrigido contraste.
4) **Mantra fixo**
   - barra no topo com mensagem de constância (psicoeducação passiva).
5) **Header cleanup**
   - removida frase redundante abaixo de “Olá, {Paciente}”.
   - telefone/WhatsApp com layout mais limpo.

## 4) Arquivos relevantes tocados hoje (alto nível)
- Rotas API (patient/admin): `resolve-phone`, `pair`, `pair-code`, `status-batch`
- UI Paciente:
  - `NextSessionCard`
  - `PatientHeader` / header do painel
  - `PatientTopMantraBar`
  - Menu do paciente (inclusão do “Contrato” e ajuste de cores)

> Observação: houve uma sequência de patches para corrigir markers e rotas. Se aparecer novamente “Merge conflict marker encountered”, buscar por `<<<<<<<` no projeto.

## 5) Checklist de validação (amanhã)
### Local
- `npm run build` (passa)
- `npm run start` e abrir `http://localhost:3000`

### Rotas
- `GET /api/patient/resolve-phone` → 200
- (quando aplicável) rotas admin relacionadas a pareamento/push → 200

### UI (Mobile)
- Card “Seu próximo atendimento” legível
- Menu: “Contrato”, “Admin”, “Sair” com texto legível
- Mantra visível sem poluir

## 6) Próximo passo recomendado
**Painel de constância (presença/faltas) e disparos de follow-up**
- Importar/consumir planilha de presença/faltas (2ª planilha).
- Construir painel de constância com indicadores simples.
- Disparos:
  - presença → reforço positivo e continuidade
  - falta → orientação breve (sem moralismo) sobre impacto de interromper processo
- Armazenamento Firestore:
  - histórico por `patientId` e/ou `phoneCanonical`;
  - sem joins; denormalização e chave canônica para consistência.

---
Gerado para reiniciar chat amanhã com continuidade, mantendo o método: **passo a passo (1 por 1), arquivo completo quando houver alteração**.
